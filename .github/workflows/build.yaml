name: build

on:
  push:
    tags:
      - 'v*'
env:
  IS_STABLE: ${{ !contains(github.ref, '-') }}

jobs:
  build:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180  # 延长超时时间
    strategy:
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: windows
            os: Windows-2022
            arch: amd64

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Android Signing
        if: startsWith(matrix.platform,'android')
        run: |
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > android/app/keystore.jks
          echo "${{ secrets.SERVICE_JSON }}" | base64 --decode > android/app/google-services.json
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/local.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/local.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/local.properties

      # 新增：配置Android SDK & NDK，解决交叉编译工具链问题
      - name: Setup Android SDK & NDK
        if: startsWith(matrix.platform,'android')
        uses: android-actions/setup-android@v3
        with:
          ndk-version: "25.2.9519653"
          build-tools-version: "34.0.0"
          sdk-version: "34"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.0'
          cache-dependency-path: |
            core/go.sum
          cache: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          flutter-version: 3.35.7
          cache: true

      - name: Get Flutter Dependency
        run: |
          flutter --version
          flutter pub get

      - name: Generate Freezed Code (Simplified)
        run: |
          echo "=== 清理旧的生成文件 ==="
          rm -rf lib/models/generated/
          rm -rf .dart_tool/build/
          
          echo "=== 重新生成 freezed 代码 ==="
          flutter packages pub run build_runner build --delete-conflicting-outputs
          
          echo "=== 简单验证 ==="
          if [ -f "lib/models/generated/profile.g.dart" ]; then
            echo "✅ 生成文件存在"
            echo "文件大小：$(wc -l < lib/models/generated/profile.g.dart) 行"
          else
            echo "❌ 生成文件不存在"
            exit 1
          fi

      # 优化：仅构建指定ARM架构，杜绝冗余编译
      - name: Build Android (ARM only)
        if: startsWith(matrix.platform,'android')
        run: |
          echo "=== 开始构建 Android (只构建 ARM 架构: arm64-v8a) ==="
          dart setup.dart android --arch arm64-v8a ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}
        env:
          ANDROID_ARCHS: "arm64-v8a"

      - name: Build Windows
        if: startsWith(matrix.platform,'windows')
        run: |
          echo "=== 开始构建 Windows ==="
          dart setup.dart windows ${{ matrix.arch && format('--arch {0}', matrix.arch) }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}${{ matrix.arch && format('-{0}', matrix.arch) }}
          path: ./dist
          overwrite: true

  # 后续 changelog、upload 任务保持不变，此处省略
  changelog:
    # ... 原有配置 ...
  upload:
    # ... 原有配置 ...
